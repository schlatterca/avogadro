"use strict";var e={};var t={kValues:Symbol("values"),kStorage:Symbol("kStorage"),kStorages:Symbol("kStorages"),kTransfromer:Symbol("kTransformer"),kTTL:Symbol("kTTL"),kOnDedupe:Symbol("kOnDedupe"),kOnError:Symbol("kOnError"),kOnHit:Symbol("kOnHit"),kOnMiss:Symbol("kOnMiss"),kStale:Symbol("kStale")},r={exports:{}};!function(e,t){const{hasOwnProperty:r}=Object.prototype,n=g();n.configure=g,n.stringify=n,n.default=n,t.stringify=n,t.configure=g,e.exports=n;const s=/[\u0000-\u001f\u0022\u005c\ud800-\udfff]|[\ud800-\udbff](?![\udc00-\udfff])|(?:[^\ud800-\udbff]|^)[\udc00-\udfff]/;function i(e){return e.length<5e3&&!s.test(e)?`"${e}"`:JSON.stringify(e)}function o(e){if(e.length>200)return e.sort();for(let t=1;t<e.length;t++){const r=e[t];let n=t;for(;0!==n&&e[n-1]>r;)e[n]=e[n-1],n--;e[n]=r}return e}const a=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(Object.getPrototypeOf(new Int8Array)),Symbol.toStringTag).get;function c(e){return void 0!==a.call(e)&&0!==e.length}function l(e,t,r){e.length<r&&(r=e.length);const n=","===t?"":" ";let s=`"0":${n}${e[0]}`;for(let i=1;i<r;i++)s+=`${t}"${i}":${n}${e[i]}`;return s}function u(e,t){let n;if(r.call(e,t)&&(n=e[t],"boolean"!=typeof n))throw new TypeError(`The "${t}" argument must be of type boolean`);return void 0===n||n}function f(e,t){let n;if(r.call(e,t)){if(n=e[t],"number"!=typeof n)throw new TypeError(`The "${t}" argument must be of type number`);if(!Number.isInteger(n))throw new TypeError(`The "${t}" argument must be an integer`);if(n<1)throw new RangeError(`The "${t}" argument must be >= 1`)}return void 0===n?1/0:n}function h(e){return 1===e?"1 item":`${e} items`}function g(e){const t=function(e){if(r.call(e,"strict")){const t=e.strict;if("boolean"!=typeof t)throw new TypeError('The "strict" argument must be of type boolean');if(t)return e=>{let t="Object can not safely be stringified. Received type "+typeof e;throw"function"!=typeof e&&(t+=` (${e.toString()})`),new Error(t)}}}(e={...e});t&&(void 0===e.bigint&&(e.bigint=!1),"circularValue"in e||(e.circularValue=Error));const n=function(e){if(r.call(e,"circularValue")){const t=e.circularValue;if("string"==typeof t)return`"${t}"`;if(null==t)return t;if(t===Error||t===TypeError)return{toString(){throw new TypeError("Converting circular structure to JSON")}};throw new TypeError('The "circularValue" argument must be of type string or the value null or undefined')}return'"[Circular]"'}(e),s=u(e,"bigint"),a=u(e,"deterministic"),g=f(e,"maximumDepth"),d=f(e,"maximumBreadth");function y(e,r,l,u,f,m){let p=r[e];switch("object"==typeof p&&null!==p&&"function"==typeof p.toJSON&&(p=p.toJSON(e)),p=u.call(r,e,p),typeof p){case"string":return i(p);case"object":{if(null===p)return"null";if(-1!==l.indexOf(p))return n;let e="",t=",";const r=m;if(Array.isArray(p)){if(0===p.length)return"[]";if(g<l.length+1)return'"[Array]"';l.push(p),""!==f&&(e+=`\n${m+=f}`,t=`,\n${m}`);const n=Math.min(p.length,d);let s=0;for(;s<n-1;s++){const r=y(String(s),p,l,u,f,m);e+=void 0!==r?r:"null",e+=t}const i=y(String(s),p,l,u,f,m);if(e+=void 0!==i?i:"null",p.length-1>d){e+=`${t}"... ${h(p.length-d-1)} not stringified"`}return""!==f&&(e+=`\n${r}`),l.pop(),`[${e}]`}let s=Object.keys(p);const v=s.length;if(0===v)return"{}";if(g<l.length+1)return'"[Object]"';let b="",w="";""!==f&&(t=`,\n${m+=f}`,b=" ");const k=Math.min(v,d);a&&!c(p)&&(s=o(s)),l.push(p);for(let r=0;r<k;r++){const n=s[r],o=y(n,p,l,u,f,m);void 0!==o&&(e+=`${w}${i(n)}:${b}${o}`,w=t)}if(v>d){e+=`${w}"...":${b}"${h(v-d)} not stringified"`,w=t}return""!==f&&w.length>1&&(e=`\n${m}${e}\n${r}`),l.pop(),`{${e}}`}case"number":return isFinite(p)?String(p):t?t(p):"null";case"boolean":return!0===p?"true":"false";case"undefined":return;case"bigint":if(s)return String(p);default:return t?t(p):void 0}}function m(e,r,o,a,c,l){switch("object"==typeof r&&null!==r&&"function"==typeof r.toJSON&&(r=r.toJSON(e)),typeof r){case"string":return i(r);case"object":{if(null===r)return"null";if(-1!==o.indexOf(r))return n;const e=l;let t="",s=",";if(Array.isArray(r)){if(0===r.length)return"[]";if(g<o.length+1)return'"[Array]"';o.push(r),""!==c&&(t+=`\n${l+=c}`,s=`,\n${l}`);const n=Math.min(r.length,d);let i=0;for(;i<n-1;i++){const e=m(String(i),r[i],o,a,c,l);t+=void 0!==e?e:"null",t+=s}const u=m(String(i),r[i],o,a,c,l);if(t+=void 0!==u?u:"null",r.length-1>d){t+=`${s}"... ${h(r.length-d-1)} not stringified"`}return""!==c&&(t+=`\n${e}`),o.pop(),`[${t}]`}o.push(r);let u="";""!==c&&(s=`,\n${l+=c}`,u=" ");let f="";for(const e of a){const n=m(e,r[e],o,a,c,l);void 0!==n&&(t+=`${f}${i(e)}:${u}${n}`,f=s)}return""!==c&&f.length>1&&(t=`\n${l}${t}\n${e}`),o.pop(),`{${t}}`}case"number":return isFinite(r)?String(r):t?t(r):"null";case"boolean":return!0===r?"true":"false";case"undefined":return;case"bigint":if(s)return String(r);default:return t?t(r):void 0}}function p(e,r,u,f,y){switch(typeof r){case"string":return i(r);case"object":{if(null===r)return"null";if("function"==typeof r.toJSON){if("object"!=typeof(r=r.toJSON(e)))return p(e,r,u,f,y);if(null===r)return"null"}if(-1!==u.indexOf(r))return n;const t=y;if(Array.isArray(r)){if(0===r.length)return"[]";if(g<u.length+1)return'"[Array]"';u.push(r);let e=`\n${y+=f}`;const n=`,\n${y}`,s=Math.min(r.length,d);let i=0;for(;i<s-1;i++){const t=p(String(i),r[i],u,f,y);e+=void 0!==t?t:"null",e+=n}const o=p(String(i),r[i],u,f,y);if(e+=void 0!==o?o:"null",r.length-1>d){e+=`${n}"... ${h(r.length-d-1)} not stringified"`}return e+=`\n${t}`,u.pop(),`[${e}]`}let s=Object.keys(r);const m=s.length;if(0===m)return"{}";if(g<u.length+1)return'"[Object]"';const v=`,\n${y+=f}`;let b="",w="",k=Math.min(m,d);c(r)&&(b+=l(r,v,d),s=s.slice(r.length),k-=r.length,w=v),a&&(s=o(s)),u.push(r);for(let e=0;e<k;e++){const t=s[e],n=p(t,r[t],u,f,y);void 0!==n&&(b+=`${w}${i(t)}: ${n}`,w=v)}if(m>d){b+=`${w}"...": "${h(m-d)} not stringified"`,w=v}return""!==w&&(b=`\n${y}${b}\n${t}`),u.pop(),`{${b}}`}case"number":return isFinite(r)?String(r):t?t(r):"null";case"boolean":return!0===r?"true":"false";case"undefined":return;case"bigint":if(s)return String(r);default:return t?t(r):void 0}}function v(e,r,u){switch(typeof r){case"string":return i(r);case"object":{if(null===r)return"null";if("function"==typeof r.toJSON){if("object"!=typeof(r=r.toJSON(e)))return v(e,r,u);if(null===r)return"null"}if(-1!==u.indexOf(r))return n;let t="";if(Array.isArray(r)){if(0===r.length)return"[]";if(g<u.length+1)return'"[Array]"';u.push(r);const e=Math.min(r.length,d);let n=0;for(;n<e-1;n++){const e=v(String(n),r[n],u);t+=void 0!==e?e:"null",t+=","}const s=v(String(n),r[n],u);if(t+=void 0!==s?s:"null",r.length-1>d){t+=`,"... ${h(r.length-d-1)} not stringified"`}return u.pop(),`[${t}]`}let s=Object.keys(r);const f=s.length;if(0===f)return"{}";if(g<u.length+1)return'"[Object]"';let y="",m=Math.min(f,d);c(r)&&(t+=l(r,",",d),s=s.slice(r.length),m-=r.length,y=","),a&&(s=o(s)),u.push(r);for(let e=0;e<m;e++){const n=s[e],o=v(n,r[n],u);void 0!==o&&(t+=`${y}${i(n)}:${o}`,y=",")}if(f>d){t+=`${y}"...":"${h(f-d)} not stringified"`}return u.pop(),`{${t}}`}case"number":return isFinite(r)?String(r):t?t(r):"null";case"boolean":return!0===r?"true":"false";case"undefined":return;case"bigint":if(s)return String(r);default:return t?t(r):void 0}}return function(e,t,r){if(arguments.length>1){let n="";if("number"==typeof r?n=" ".repeat(Math.min(r,10)):"string"==typeof r&&(n=r.slice(0,10)),null!=t){if("function"==typeof t)return y("",{"":e},[],t,n,"");if(Array.isArray(t))return m("",e,[],function(e){const t=new Set;for(const r of e)("string"==typeof r||"number"==typeof r)&&t.add(String(r));return t}(t),n,"")}if(0!==n.length)return p("",e,[],n,"")}return v("",e,[])}}}(r,r.exports);var n=r.exports;function s(e){return e*Math.random()|0}var i={findNotMatching:function(e,t){const r=[];let n=0;for(let s=0;s<e.length;s++)for(let i=n;i<t.length;i++)e[s]!==t[i]&&(r.push(t[i]),n=i+1);return r},findMatchingIndexes:function(e,t){const r=[];let n=0;for(let s=0;s<e.length;s++)for(let i=n;i<t.length;i++)e[s]===t[i]&&(r.push(i),n=i+1);return r},bsearchIndex:function(e,t){let r=0,n=e.length-1;for(;r<=n;){const s=(r+n)/2|0;if(e[s]===t)return s;e[s]<t?r=s+1:n=s-1}return-1},wildcardMatch:function(e,t){if("*"===e||e.length===t.length&&e===t)return!0;let r=0,n=0;for(;r<e.length&&n<t.length;)if(e[r]!==t[n]){if("*"!==e[r])return!1;if(e[r+1]===t[n]){r++;continue}n++}else r++,n++;return r>=e.length-1},randomSubset:function(e,t){if(e.length<1||t<1)return[];const r=Math.min(e.length,t),n=(o=1,a=r,(o=Math.floor(o))+s(1+(a=Math.floor(a))-o)),i=new Set;var o,a;for(let t=0;t<n;t++)i.add(s(e.length));const c=[];for(const t of i)c.push(e[t]);return c},abstractLogging:function(){const e=()=>{};return{fatal:e,error:e,warn:e,info:e,debug:e,trace:e}},isServerSide:typeof window>"u"};var o,a,c=class{constructor(e){this.options=e}async get(e){throw new Error("storage get method not implemented")}async set(e,t,r,n){throw new Error("storage set method not implemented")}async remove(e){throw new Error("storage remove method not implemented")}async invalidate(e){throw new Error("storage invalidate method not implemented")}async clear(e){throw new Error("storage clear method not implemented")}async refresh(){throw new Error("storage refresh method not implemented")}};function l(e){if("function"!=typeof e)throw new Error("obliterator/iterator: expecting a function!");this.next=e}typeof Symbol<"u"&&(l.prototype[Symbol.iterator]=function(){return this}),l.of=function(){var e=arguments,t=e.length,r=0;return new l((function(){return r>=t?{done:!0}:{done:!1,value:e[r++]}}))},l.empty=function(){return new l((function(){return{done:!0}}))},l.fromSequence=function(e){var t=0,r=e.length;return new l((function(){return t>=r?{done:!0}:{done:!1,value:e[t++]}}))},l.is=function(e){return e instanceof l||"object"==typeof e&&null!==e&&"function"==typeof e.next};var u=l,f={};f.ARRAY_BUFFER_SUPPORT=typeof ArrayBuffer<"u",f.SYMBOL_SUPPORT=typeof Symbol<"u";var h=f,g=h.ARRAY_BUFFER_SUPPORT,d=h.SYMBOL_SUPPORT,y=function(e,t){var r,n,s,i,o;if(!e)throw new Error("obliterator/forEach: invalid iterable.");if("function"!=typeof t)throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(e)||g&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(s=0,i=e.length;s<i;s++)t(e[s],s);else if("function"!=typeof e.forEach)if(d&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&t(e[n],n);else for(r=e,s=0;!0!==(o=r.next()).done;)t(o.value,s),s++;else e.forEach(t)},m={};!function(e){var t=Math.pow(2,8)-1,r=Math.pow(2,16)-1,n=Math.pow(2,32)-1,s=Math.pow(2,7)-1,i=Math.pow(2,15)-1,o=Math.pow(2,31)-1;e.getPointerArray=function(e){var s=e-1;if(s<=t)return Uint8Array;if(s<=r)return Uint16Array;if(s<=n)return Uint32Array;throw new Error("mnemonist: Pointer Array of size > 4294967295 is not supported.")},e.getSignedPointerArray=function(e){var t=e-1;return t<=s?Int8Array:t<=i?Int16Array:t<=o?Int32Array:Float64Array},e.getNumberType=function(e){return e===(0|e)?-1===Math.sign(e)?e<=127&&e>=-128?Int8Array:e<=32767&&e>=-32768?Int16Array:Int32Array:e<=255?Uint8Array:e<=65535?Uint16Array:Uint32Array:Float64Array};var a={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};e.getMinimalRepresentation=function(t,r){var n,s,i,o,c,l=null,u=0;for(o=0,c=t.length;o<c;o++)i=r?r(t[o]):t[o],s=e.getNumberType(i),(n=a[s.name])>u&&(u=n,l=s);return l},e.isTypedArray=function(e){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e)},e.concat=function(){var e,t,r,n=0;for(e=0,r=arguments.length;e<r;e++)n+=arguments[e].length;var s=new arguments[0].constructor(n);for(e=0,t=0;e<r;e++)s.set(arguments[e],t),t+=arguments[e].length;return s},e.indices=function(t){for(var r=new(e.getPointerArray(t))(t),n=0;n<t;n++)r[n]=n;return r}}(m);var p={},v=y,b=m;function w(e){return"number"==typeof e.length?e.length:"number"==typeof e.size?e.size:void 0}p.isArrayLike=function(e){return Array.isArray(e)||b.isTypedArray(e)},p.guessLength=w,p.toArray=function(e){var t=w(e),r="number"==typeof t?new Array(t):[],n=0;return v(e,(function(e){r[n++]=e})),r},p.toArrayWithIndices=function(e){var t=w(e),r="number"==typeof t?b.getPointerArray(t):Array,n="number"==typeof t?new Array(t):[],s="number"==typeof t?new r(t):[],i=0;return v(e,(function(e){n[i]=e,s[i]=i++})),[n,s]};var k=u,S=y,E=m,R=p;function $(e,t,r){if(arguments.length<2&&(r=e,e=null,t=null),this.capacity=r,"number"!=typeof this.capacity||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");if(!isFinite(this.capacity)||Math.floor(this.capacity)!==this.capacity)throw new Error("mnemonist/lru-cache: capacity should be a finite positive integer.");var n=E.getPointerArray(r);this.forward=new n(r),this.backward=new n(r),this.K="function"==typeof e?new e(r):new Array(r),this.V="function"==typeof t?new t(r):new Array(r),this.size=0,this.head=0,this.tail=0,this.items={}}$.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}},$.prototype.splayOnTop=function(e){var t=this.head;if(this.head===e)return this;var r=this.backward[e],n=this.forward[e];return this.tail===e?this.tail=r:this.backward[n]=r,this.forward[r]=n,this.backward[t]=e,this.head=e,this.forward[e]=t,this},$.prototype.set=function(e,t){var r=this.items[e];if(typeof r<"u")return this.splayOnTop(r),void(this.V[r]=t);this.size<this.capacity?r=this.size++:(r=this.tail,this.tail=this.backward[r],delete this.items[this.K[r]]),this.items[e]=r,this.K[r]=e,this.V[r]=t,this.forward[r]=this.head,this.backward[this.head]=r,this.head=r},$.prototype.setpop=function(e,t){var r=null,n=null,s=this.items[e];return typeof s<"u"?(this.splayOnTop(s),r=this.V[s],this.V[s]=t,{evicted:!1,key:e,value:r}):(this.size<this.capacity?s=this.size++:(s=this.tail,this.tail=this.backward[s],r=this.V[s],n=this.K[s],delete this.items[n]),this.items[e]=s,this.K[s]=e,this.V[s]=t,this.forward[s]=this.head,this.backward[this.head]=s,this.head=s,n?{evicted:!0,key:n,value:r}:null)},$.prototype.has=function(e){return e in this.items},$.prototype.get=function(e){var t=this.items[e];if(!(typeof t>"u"))return this.splayOnTop(t),this.V[t]},$.prototype.peek=function(e){var t=this.items[e];if(!(typeof t>"u"))return this.V[t]},$.prototype.forEach=function(e,t){t=arguments.length>1?t:this;for(var r=0,n=this.size,s=this.head,i=this.K,o=this.V,a=this.forward;r<n;)e.call(t,o[s],i[s],this),s=a[s],r++},$.prototype.keys=function(){var e=0,t=this.size,r=this.head,n=this.K,s=this.forward;return new k((function(){if(e>=t)return{done:!0};var i=n[r];return++e<t&&(r=s[r]),{done:!1,value:i}}))},$.prototype.values=function(){var e=0,t=this.size,r=this.head,n=this.V,s=this.forward;return new k((function(){if(e>=t)return{done:!0};var i=n[r];return++e<t&&(r=s[r]),{done:!1,value:i}}))},$.prototype.entries=function(){var e=0,t=this.size,r=this.head,n=this.K,s=this.V,i=this.forward;return new k((function(){if(e>=t)return{done:!0};var o=n[r],a=s[r];return++e<t&&(r=i[r]),{done:!1,value:[o,a]}}))},typeof Symbol<"u"&&($.prototype[Symbol.iterator]=$.prototype.entries),$.prototype.inspect=function(){for(var e,t=new Map,r=this.entries();!(e=r.next()).done;)t.set(e.value[0],e.value[1]);return Object.defineProperty(t,"constructor",{value:$,enumerable:!1}),t},typeof Symbol<"u"&&($.prototype[Symbol.for("nodejs.util.inspect.custom")]=$.prototype.inspect),$.from=function(e,t,r,n){if(arguments.length<2){if("number"!=typeof(n=R.guessLength(e)))throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else 2===arguments.length&&(n=t,t=null,r=null);var s=new $(t,r,n);return S(e,(function(e,t){s.set(t,e)})),s};const A=$,{abstractLogging:T}=i,O=c,{findMatchingIndexes:K,findNotMatching:M,bsearchIndex:_,wildcardMatch:x}=i,z=typeof globalThis.setImmediate<"u"?globalThis.setImmediate:(e,...t)=>setTimeout(e,0,...t);let L;function N(){if(void 0!==L)return L;L=Math.floor(Date.now()/1e3);const e=setTimeout(j,1e3);return"function"==typeof e.unref&&e.unref(),L}function j(){L=void 0}var P=class extends O{constructor(e={}){if(e.size&&("number"!=typeof e.size||e.size<1))throw new Error("size must be a positive integer greater than 0");super(e),this.size=e.size||1024,this.log=e.log||T(),this.invalidation=e.invalidation||!1,this.init()}init(){this.store=new A(this.size),this.invalidation&&(this.keysReferences=new Map,this.referencesKeys=new Map)}get(e){this.log.debug({msg:"acd/storage/memory.get",key:e});const t=this.store.get(e);if(t){if(this.log.debug({msg:"acd/storage/memory.get, entry",entry:t,now:N()}),t.start+t.ttl>N())return this.log.debug({msg:"acd/storage/memory.get, key is NOT expired",key:e,entry:t}),t.value;this.log.debug({msg:"acd/storage/memory.get, key is EXPIRED",key:e,entry:t}),z((()=>this.remove(e)))}}getTTL(e){this.log.debug({msg:"acd/storage/memory.getTTL",key:e});const t=this.store.peek(e);let r=0;return t&&(r=t.start+t.ttl-N(),r<0&&(r=0)),r}set(e,t,r,n){if(this.log.debug({msg:"acd/storage/memory.set",key:e,value:t,ttl:r,references:n}),!(r=Number(r))||r<0)return;const s=this.store.has(e),i=this.store.setpop(e,{value:t,ttl:r,start:N()});if(this.log.debug({msg:"acd/storage/memory.set, evicted",removed:i}),i&&i.evicted&&(this.log.debug({msg:"acd/storage/memory.set, remove evicted key",key:i.key}),this._removeReferences([i.key])),!n||n.length<1)return;if(!this.invalidation)return void this.log.warn({msg:"acd/storage/memory.set, invalidation is disabled, references are useless"});let o;if(n=[...new Set(n)],s&&(o=this.keysReferences.get(e),this.log.debug({msg:"acd/storage/memory.set, current keys-references",key:e,references:o}),o)){o.sort(),n.sort();const t=M(n,o);for(const r of t){const t=this.referencesKeys.get(r);if(!t)continue;const n=_(t,e);if(!(n<0)){if(t.splice(n,1),t.length<1){this.referencesKeys.delete(r);continue}this.referencesKeys.set(r,t)}}}const a=o?M(o,n):n;for(let t=0;t<a.length;t++){const r=a[t];let n=this.referencesKeys.get(r);n?(this.log.debug({msg:"acd/storage/memory.set, add reference-key",key:e,reference:r}),n.push(e)):n=[e],this.log.debug({msg:"acd/storage/memory.set, set reference-keys",keys:n,reference:r}),this.referencesKeys.set(r,n)}this.keysReferences.set(e,n)}remove(e){this.log.debug({msg:"acd/storage/memory.remove",key:e});const t=this._removeKey(e);return this._removeReferences([e]),t}_removeKey(e){return this.log.debug({msg:"acd/storage/memory._removeKey",key:e}),!!this.store.has(e)&&(this.store.set(e,void 0),!0)}_removeReferences(e){if(!this.invalidation)return;this.log.debug({msg:"acd/storage/memory._removeReferences",keys:e});const t=new Set;for(let r=0;r<e.length;r++){const n=e[r],s=this.keysReferences.get(n);if(s){for(let e=0;e<s.length;e++)t.add(s[e]);this.log.debug({msg:"acd/storage/memory._removeReferences, delete key-references",key:n}),this.keysReferences.delete(n)}}this._removeReferencesKeys([...t],e)}_removeReferencesKeys(e,t){t.sort(),this.log.debug({msg:"acd/storage/memory._removeReferencesKeys",references:e,keys:t});for(let r=0;r<e.length;r++){const n=e[r],s=this.referencesKeys.get(n);if(this.log.debug({msg:"acd/storage/memory._removeReferencesKeys, get reference-key",reference:n,keys:t,referencesKeys:s}),!s)continue;const i=K(t,s);if(this.log.debug({msg:"acd/storage/memory._removeReferencesKeys, removing",reference:n,referencesToRemove:i,referencesKeys:s}),i.length!==s.length)for(let e=i.length-1;e>=0;e--)this.log.debug({msg:"acd/storage/memory._removeReferencesKeys, remove",reference:n,referencesKeys:s,at:i[e]}),s.splice(i[e],1);else this.log.debug({msg:"acd/storage/memory._removeReferencesKeys, delete",reference:n}),this.referencesKeys.delete(n)}}invalidate(e){return this.invalidation?(this.log.debug({msg:"acd/storage/memory.invalidate",references:e}),Array.isArray(e)?this._invalidateReferences(e):this._invalidateReference(e)):(this.log.warn({msg:"acd/storage/memory.invalidate, exit due invalidation is disabled"}),[])}_invalidateReferences(e){const t=[];for(let r=0;r<e.length;r++){const n=e[r],s=this.referencesKeys.get(n);if(this.log.debug({msg:"acd/storage/memory._invalidateReferences, remove keys on reference",reference:n,keys:s}),s){for(let e=0;e<s.length;e++){const r=s[e];this.log.debug({msg:"acd/storage/memory._invalidateReferences, remove key on reference",reference:n,key:r}),this._removeKey(r)&&t.push(r)}this.log.debug({msg:"acd/storage/memory._invalidateReferences, remove references of",reference:n,keys:s}),this._removeReferences([...s])}}return t}_invalidateReference(e){if(e.includes("*")){const t=[];for(const r of this.referencesKeys.keys())x(e,r)&&t.push(r);return this._invalidateReferences(t)}const t=this.referencesKeys.get(e),r=[];if(this.log.debug({msg:"acd/storage/memory._invalidateReference, remove keys on reference",reference:e,keys:t}),!t)return r;for(let n=0;n<t.length;n++){const s=t[n];this.log.debug({msg:"acd/storage/memory._invalidateReference, remove key on reference",reference:e,key:s}),this._removeKey(s)&&r.push(s)}return this.log.debug({msg:"acd/storage/memory._invalidateReference, remove references of",reference:e,keys:t}),this._removeReferences([...t]),r}clear(e){if(this.log.debug({msg:"acd/storage/memory.clear",name:e}),!e){if(this.store.clear(),!this.invalidation)return;return this.referencesKeys.clear(),void this.keysReferences.clear()}const t=[];this.store.forEach(((r,n)=>{this.log.debug({msg:"acd/storage/memory.clear, iterate key",key:n}),0===n.indexOf(e)&&(this.log.debug({msg:"acd/storage/memory.clear, remove key",key:n}),t.push(n))}));const r=[];for(let e=0;e<t.length;e++)this._removeKey(t[e])&&r.push(t[e]);return this._removeReferences(r),r}refresh(){this.log.debug({msg:"acd/storage/memory.refresh"}),this.init()}};const{isServerSide:V}=i;let F;V&&(F=function(){if(a)return o;a=1;const e=n,t=c,{findNotMatching:r,randomSubset:s,abstractLogging:l}=i;return o=class extends t{constructor(e={}){if(!e.client||"object"!=typeof e.client)throw new Error("Redis client is required");if(super(e),e.invalidation&&e.invalidation.referencesTTL&&("number"!=typeof e.invalidation.referencesTTL||e.invalidation.referencesTTL<1))throw new Error("invalidation.referencesTTL must be a positive integer greater than 1");this.log=e.log||l(),this.store=e.client,this.invalidation=!!e.invalidation,this.referencesTTL=e.invalidation&&e.invalidation.referencesTTL||60}getReferenceKeyLabel(e){return`r:${e}`}getKeyReferenceLabel(e){return`k:${e}`}async get(e){this.log.debug({msg:"acd/storage/redis.get",key:e});try{const t=await this.store.get(e);if(!t){if(!this.invalidation)return;return void this.clearReferences(e)}return JSON.parse(t)}catch(t){this.log.error({msg:"acd/storage/redis.get error",err:t,key:e})}}async getTTL(e){this.log.debug({msg:"acd/storage/memory.getTTL",key:e});let t=await this.store.pttl(e);return t<0?0:(t=Math.ceil(t/1e3),t)}async set(t,n,s,i){if(this.log.debug({msg:"acd/storage/redis.set key",key:t,value:n,ttl:s,references:i}),(s=Number(s))&&!(s<0))try{if(await this.store.set(t,e(n),"EX",s),!i||i.length<1)return;if(!this.invalidation)return void this.log.warn({msg:"acd/storage/redis.set, invalidation is disabled, references are useless",key:t,references:i});const o=[],a=await this.store.smembers(this.getKeyReferenceLabel(t));if(this.log.debug({msg:"acd/storage/redis.set current references",key:t,currentReferences:a}),a.length>1){a.sort(),i.sort();const e=r(i,a);for(const r of e)o.push(["srem",this.getReferenceKeyLabel(r),t]);o.push(["del",this.getKeyReferenceLabel(t)])}const c=a.length>1?r(a,i):i;this.log.debug({msg:"acd/storage/redis.set references to add",key:t,referencesToAdd:c});for(let e=0;e<c.length;e++){const r=c[e],n=this.getReferenceKeyLabel(r);o.push(["sadd",n,t]),o.push(["expire",n,this.referencesTTL])}const l=this.getKeyReferenceLabel(t);o.push(["sadd",l,i]),o.push(["expire",l,s]),this.log.debug({msg:"acd/storage/redis.set references writes",writes:o}),await this.store.pipeline(o).exec()}catch(e){this.log.error({msg:"acd/storage/redis.set error",err:e,key:t,ttl:s,references:i})}}async remove(e){this.log.debug({msg:"acd/storage/redis.remove",key:e});try{const t=await this.store.del(e)>0;return t&&this.invalidation&&await this.clearReferences(e),t}catch(t){this.log.error({msg:"acd/storage/redis.remove error",err:t,key:e})}}async invalidate(e){if(!this.invalidation)return this.log.warn({msg:"acd/storage/redis.invalidate, exit due invalidation is disabled"}),[];this.log.debug({msg:"acd/storage/redis.invalidate",references:e});try{return Array.isArray(e)?await this._invalidateReferences(e):await this._invalidateReference(e)}catch(t){return this.log.error({msg:"acd/storage/redis.invalidate error",err:t,references:e}),[]}}async _invalidateReferences(e,t=!0){const r=e.map((e=>["smembers",t?this.getReferenceKeyLabel(e):e])),n=await this.store.pipeline(r).exec();this.log.debug({msg:"acd/storage/redis._invalidateReferences keys",keys:n});const s=[],i=[];for(let e=0;e<n.length;e++){const t=n[e][1];if(t){this.log.debug({msg:"acd/storage/redis._invalidateReferences got keys to be invalidated",keys:t});for(let e=0;e<t.length;e++){const r=t[e];this.log.debug({msg:"acd/storage/redis._invalidateReferences del key"+r}),i.push(r),s.push(["del",r])}}}return await this.store.pipeline(s).exec(),await this.clearReferences(i),i}async _invalidateReference(e){let t;if(e.includes("*")){const t=await this.store.keys(this.getReferenceKeyLabel(e));return this._invalidateReferences(t,!1)}t=await this.store.smembers(this.getReferenceKeyLabel(e)),this.log.debug({msg:"acd/storage/redis._invalidateReference keys",keys:t});const r=[],n=[];for(let e=0;e<t.length;e++){const s=t[e];this.log.debug({msg:"acd/storage/redis._invalidateReference del key"+s}),n.push(s),r.push(["del",s])}return await this.store.pipeline(r).exec(),await this.clearReferences(n),n}async clear(e){this.log.debug({msg:"acd/storage/redis.clear",name:e});try{if(!e)return void await this.store.flushall();const t=await this.store.keys(`${e}*`);this.log.debug({msg:"acd/storage/redis.clear keys",keys:t});const r=t.map((e=>["del",e]));if(await this.store.pipeline(r).exec(),!this.invalidation)return;await this.clearReferences(t)}catch(t){this.log.error({msg:"acd/storage/redis.clear error",err:t,name:e})}}async refresh(){try{await this.store.flushall()}catch(e){this.log.error({msg:"acd/storage/redis.refresh error",err:e})}}async clearReferences(e){try{if(!e)return void this.log.warn({msg:"acd/storage/redis.clearReferences invalid call due to empty key"});Array.isArray(e)||(e=[e]);const t=e.map((e=>["smembers",this.getKeyReferenceLabel(e)])),r=await this.store.pipeline(t).exec();this.log.debug({msg:"acd/storage/redis.clearReferences references",keys:e,referencesKeys:r});const n={};for(let t=0;t<e.length;t++){for(let s=0;s<r[t][1].length;s++){const i=this.getReferenceKeyLabel(r[t][1][s]);n[i]||(n[i]=["srem",i,e])}const s=this.getKeyReferenceLabel(e[t]);n[s]=["del",s]}this.log.debug({msg:"acd/storage/redis.clearReferences writes pipeline",writes:n}),await this.store.pipeline(Object.values(n)).exec()}catch(e){this.log.error({msg:"acd/storage/redis.clearReferences error",err:e})}}async gc(e="lazy",t={}){if(this.log.debug({msg:"acd/storage/redis.gc",mode:e,options:t}),!this.invalidation)return void this.log.warn({msg:"acd/storage/redis.gc does not run due to invalidation is disabled"});"strict"!==e&&"lazy"!==e&&(e="lazy");const r={references:{scanned:[],removed:[]},keys:{scanned:new Set,removed:new Set},loops:0,cursor:0,error:null};try{let n=0,i=64;if(t.chunk&&("number"!=typeof t.chunk||t.chunk<1))return r.error=new Error("chunk must be a positive integer greater than 1"),r;if(t.lazy){if(t.lazy.chunk){if("number"!=typeof t.lazy.chunk||t.lazy.chunk<1)return r.error=new Error("lazy.chunk must be a positive integer greater than 1"),r;i=t.lazy.chunk}if(t.lazy.cursor){if("number"!=typeof t.lazy.cursor||t.lazy.cursor<0)return r.error=new Error("lazy.cursor must be a positive integer greater than 0"),r;n=t.lazy.cursor}}const o=t.chunk||64,a=Math.min(i,o),c=n;let l=-1,u=-1;do{r.loops++;const t=await this.store.scan(n,"match","r:*","count",a);n=Number(t[0]),l=t[1].length;const o="lazy"===e?s(t[1],i):t[1];r.references.scanned=r.references.scanned.concat(o);let c=[];for(let e=0;e<o.length;e++){const t=o[e];c.push(["smembers",t])}const f=await this.store.pipeline(c).exec(),h={},g={};for(let e=0;e<f.length;e++){const t=f[e],n=o[e];g[n]=t[1];for(let e=0;e<t[1].length;e++){const s=t[1][e];h[s]?h[s].push(n):h[s]=[n],r.keys.scanned.add(s)}}const d=Object.keys(h);c=d.map((e=>["exists",e]));const y=await this.store.pipeline(c).exec(),m={};for(let e=0;e<d.length;e++){const t=d[e];if(1!==y[e][1])for(let e=0;e<h[t].length;e++){const n=h[t][e];m[n]?m[n].push(t):m[n]=[t],r.keys.removed.add(t)}}const p=Object.keys(m),v=[];for(let e=0;e<p.length;e++){const t=p[e];g[t].length===m[t].length?(v.push(["del",t]),r.references.removed.push(t)):v.push(["srem",t,m[t]])}if(await this.store.pipeline(v).exec(),u=v.length,"lazy"===e&&r.references.scanned.length>=i)break}while(c!==n&&l>0&&u>0);r.cursor=n,r.keys.scanned=Array.from(r.keys.scanned),r.keys.removed=Array.from(r.keys.removed)}catch(e){this.log.error({msg:"acd/storage/redis.gc error",err:e}),r.error=e}return r}}}());const I=P,C="redis";var D=function(e,t){if(!V&&e===C)throw new Error("Redis storage is not supported in the browser");return e===C?new F(t):new I(t)};const{kValues:U,kStorage:J,kStorages:q,kTransfromer:H,kTTL:B,kOnDedupe:Y,kOnError:X,kOnHit:W,kOnMiss:G,kStale:Q}=t,Z=n,ee=D;class te{constructor(e,t,r,n,s,i,o,a,c,l,u,f){this.dedupes=new Map,this.func=e,this.name=t,this.serialize=r,this.references=n,this.storage=s,this.transformer=i,this.ttl=o,this.onDedupe=a,this.onError=c,this.onHit=l,this.onMiss=u,this.stale=f}getKey(e){const t=this.serialize?this.serialize(e):e;return"string"==typeof t?t:Z(t)}getStorageKey(e){return`${this.name}~${e}`}getStorageName(){return`${this.name}~`}add(e){try{const t=this.getKey(e);let r=this.dedupes.get(t);return r?this.onDedupe(t):(r=new re,this.buildPromise(r,e,t),this.dedupes.set(t,r)),r.promise}catch(e){this.onError(e)}}async wrapFunction(e,t){const r=this.getStorageKey(t);if(this.ttl>0||"function"==typeof this.ttl){const n=await this.get(r);if(void 0!==n){this.onHit(t);const s="function"==typeof this.stale?this.stale(n):this.stale;return s>0&&await this.storage.getTTL(r)<=s&&this._wrapFunction(r,e,t).catch(ne),n}this.onMiss(t)}return this._wrapFunction(r,e,t)}async _wrapFunction(e,t,r){const n=await this.func(t,r),s="function"==typeof this.stale?this.stale(n):this.stale;let i="function"==typeof this.ttl?this.ttl(n):this.ttl;if(null==i||"number"!=typeof i||!Number.isInteger(i))return this.onError(new Error("ttl must be an integer")),n;if(i+=s,i<1)return n;if(!this.references)return await this.set(e,n,i),n;try{let s=this.references(t,r,n),o=n;s&&"function"==typeof s.then&&(s=await s),this.transformer&&(o=this.transformer.serialize(n)),await this.storage.set(e,o,i,s)}catch(e){this.onError(e)}return n}buildPromise(e,t,r){e.promise=this.wrapFunction(t,r),e.promise.then((e=>(this.dedupes.delete(r),e))).catch((e=>{this.onError(e),this.dedupes.delete(r);const t=this.storage.remove(this.getStorageKey(r));t&&"function"==typeof t.catch&&t.catch(ne)}))}async clear(e){if(e){const t=this.getKey(e);return this.dedupes.delete(t),void await this.storage.remove(this.getStorageKey(t))}await this.storage.clear(this.getStorageName()),this.dedupes.clear()}async get(e){const t=await this.storage.get(e);return this.transformer&&t?await this.transformer.deserialize(t):t}async set(e,t,r,n){return this.transformer&&(t=this.transformer.serialize(t)),this.storage.set(e,t,r,n)}async invalidate(e){return this.storage.invalidate(e)}}class re{constructor(){this.promise=null}}function ne(){}e.Cache=class{constructor(e={}){if(!e.storage)throw new Error("storage is required");if(e.ttl&&"number"==typeof e.ttl&&(e.ttl<0||!Number.isInteger(e.ttl)))throw new Error("ttl must be a positive integer greater than 0");if(e.onDedupe&&"function"!=typeof e.onDedupe)throw new Error("onDedupe must be a function");if(e.onError&&"function"!=typeof e.onError)throw new Error("onError must be a function");if(e.onHit&&"function"!=typeof e.onHit)throw new Error("onHit must be a function");if(e.onMiss&&"function"!=typeof e.onMiss)throw new Error("onMiss must be a function");if("number"==typeof e.stale&&!(Math.floor(e.stale)===e.stale&&e.stale>=0))throw new Error("stale must be an integer greater or equal to 0");this[U]={},this[J]=e.storage,this[q]=new Map,this[q].set("_default",e.storage),this[H]=e.transformer,this[B]=e.ttl||0,this[Y]=e.onDedupe||ne,this[X]=e.onError||ne,this[W]=e.onHit||ne,this[G]=e.onMiss||ne,this[Q]=e.stale||0}define(e,t,r){if("function"==typeof t&&(r=t,t={}),e&&this[e])throw new Error(`${e} is already defined in the cache or it is a forbidden name`);if(t=t||{},"function"!=typeof r)throw new TypeError(`Missing the function parameter for '${e}'`);const n=t.serialize;if(n&&"function"!=typeof n)throw new TypeError("serialize must be a function");const s=t.references;if(s&&"function"!=typeof s)throw new TypeError("references must be a function");if("function"!=typeof t.ttl&&t.ttl&&("number"!=typeof t.ttl||t.ttl<0||!Number.isInteger(t.ttl)))throw new Error("ttl must be a positive integer greater than 0");let i;t.storage?(i=ee(t.storage.type,t.storage.options),this[q].set(e,i)):i=this[J];const o=void 0!==t.ttl?t.ttl:this[B],a=void 0!==t.stale?t.stale:this[Q],c=t.onDedupe||this[Y],l=t.onError||this[X],u=t.onHit||this[W],f=t.onMiss||this[G],h=t.transformer||this[H],g=new te(r,e,n,s,i,h,o,c,l,u,f,a);return this[U][e]=g,this[e]=g.add.bind(g),this}async clear(e,t){if(e){if(!this[U][e])throw new Error(`${e} is not defined in the cache`);return void await this[U][e].clear(t)}const r=[];for(const e of Object.values(this[U]))r.push(e.clear());await Promise.all(r)}async get(e,t){if(!this[U][e])throw new Error(`${e} is not defined in the cache`);return this[U][e].get(t)}async set(e,t,r,n,s){if(!this[U][e])throw new Error(`${e} is not defined in the cache`);return this[U][e].set(t,r,n,s)}async invalidate(e,t){if(!this[U][e])throw new Error(`${e} is not defined in the cache`);return this[U][e].invalidate(t)}async invalidateAll(e,t="_default"){if(!this[q].has(t))throw new Error(`${t} storage is not defined in the cache`);await this[q].get(t).invalidate(e)}};const{Cache:se}=e,ie=D;var oe={Cache:se,createCache:function(e){e?e.storage||(e.storage={type:"memory"}):e={storage:{type:"memory"}};const t=ie(e.storage.type,e.storage.options);return new se({...e,storage:t})},createStorage:ie};let ae=0,ce=[];let le=Symbol("clean"),ue=[],fe=(e,t)=>{let r=[],n={get:()=>(n.lc||n.listen((()=>{}))(),n.value),l:t||0,lc:0,listen:(e,t)=>(n.lc=r.push(e,t||n.l)/2,()=>{let t=r.indexOf(e);~t&&(r.splice(t,2),--n.lc||n.off())}),notify(e,t){let s=!ue.length;for(let s=0;s<r.length;s+=2)ue.push(r[s],r[s+1],n.value,e,t);if(s){for(let e=0;e<ue.length;e+=5){let t;for(let r=e+1;!t&&(r+=5)<ue.length;)ue[r]<ue[e+1]&&(t=ue.push(ue[e],ue[e+1],ue[e+2],ue[e+3],ue[e+4]));t||ue[e](ue[e+2],ue[e+3],ue[e+4])}ue.length=0}},off(){},set(e){let t=n.value;t!==e&&(n.value=e,n.notify(t))},subscribe(e,t){let r=n.listen(e,t);return e(n.value),r},value:e};return"production"!==process.env.NODE_ENV&&(n[le]=()=>{r=[],n.lc=0,n.off()}),n};const he=typeof document>"u"?"server":"browser";function ge(e){return e.withConfig({allowReconfigure:!1})}exports.a=fe,exports.c=e=>{const{ssr:t=!1,tag:r="core-loader"}=e;if(t&&e.client)throw new TypeError("`client` option is not allowed when `ssr: true`, use `setServerClient` from your server entry point instead");if(!t&&!1===e.client)throw new TypeError("You must set `ssr: true` when `client: false` is used");if(!t&&!e.client)throw new TypeError("`client` is required");let n=t?void 0:ge(e.client);function s(e){return oe.createCache().define("fetch",(async t=>{if(!e)throw new Error("You have to set the Sanity client with `setServerClient` before any data fetching is done");const{query:n,params:s={},perspective:i,useCdn:o}=JSON.parse(t),{result:a,resultSourceMap:c}=await e.fetch(n,s,{tag:r,filterResponse:!1,perspective:i,useCdn:o});return{result:a,resultSourceMap:c}}))}function i(){const e=(null==n?void 0:n.config().perspective)||"published";return o.instance=s(n),{hydrate:(t,r,n)=>({loading:void 0===(null==n?void 0:n.data)||void 0===(null==n?void 0:n.sourceMap),error:void 0,data:null==n?void 0:n.data,sourceMap:null==n?void 0:n.sourceMap,perspective:e}),fetch:(t,r,n,s)=>{if(s.signal.aborted)return;const i=(ae+=1,()=>{if(ae-=1,0===ae){let e=ce;ce=[];for(let t of e)t()}});n.setKey("loading",!0),n.setKey("error",void 0),o.instance.fetch(JSON.stringify({query:t,params:r})).then((t=>{s.signal.aborted||(n.setKey("data",t.result),n.setKey("sourceMap",t.resultSourceMap),n.setKey("perspective",e))})).catch((e=>{n.setKey("error",e)})).finally((()=>{n.setKey("loading",!1),i()}))}}}const o={instance:s(n)},a=fe(n?i():void 0),c=(e=>{const{ssr:t,setFetcher:r}=e;return n=>{if("server"===he)throw new Error("Live mode is not supported in server environments");if(t&&!n.client)throw new Error("The `client` option in `enableLiveMode` is required");const s=n.client||e.client||void 0,i=new AbortController;let o;return Promise.resolve().then((function(){return require("./enableLiveMode.cjs")})).then((({enableLiveMode:e})=>{i.signal.aborted||(o=e({...n,client:s,setFetcher:r,ssr:t}))})),()=>{i.abort(),null==o||o()}}})({client:n||void 0,ssr:t,setFetcher:e=>{const t=a.get();return a.set(e),()=>a.set(t)}}),l={instance:void 0,canPreviewDrafts:!1};return{createFetcherStore:(e,t={},r)=>{const n=a.get(),s=((e={})=>{let t=fe(e);return t.setKey=function(e,r){let n=t.value;typeof r>"u"&&e in t.value?(t.value={...t.value},delete t.value[e],t.notify(n,e)):t.value[e]!==r&&(t.value={...t.value,[e]:r},t.notify(n,e))},t})(n?n.hydrate(e,t,r):{loading:!1,error:typeof(null==r?void 0:r.data)>"u"?new Error("The `initial` option is required when `ssr: true`"):void 0,data:null==r?void 0:r.data,sourceMap:null==r?void 0:r.sourceMap,perspective:null==r?void 0:r.perspective});return o=()=>{let r=new AbortController;const n=a.subscribe((n=>{!n||r.signal.aborted||(r.abort(),r=new AbortController,n.fetch(e,t,s,r))}));return()=>{r.abort(),n()}},l=e=>{let t=o(e);t&&i.events[6].push(t)},u=5,f=e=>{let t=i.listen;i.listen=(...r)=>(!i.lc&&!i.active&&(i.active=!0,e()),t(...r));let r=i.off;if(i.events[6]=[],i.off=()=>{r(),setTimeout((()=>{if(i.active&&!i.lc){i.active=!1;for(let e of i.events[6])e();i.events[6]=[]}}),1e3)},"production"!==process.env.NODE_ENV){let e=i[le];i[le]=()=>{for(let e of i.events[6])e();i.events[6]=[],i.active=!1,e()}}return()=>{i.listen=t,i.off=r}},(c=i=s).events=c.events||{},c.events[u+10]||(c.events[u+10]=f((e=>{c.events[u].reduceRight(((e,t)=>(t(e),e)),{shared:{},...e})}))),c.events[u]=c.events[u]||[],c.events[u].push(l),s;var i,o,c,l,u,f},enableLiveMode:c,setServerClient:e=>{if("server"!==he)throw new Error("`setServerClient` can only be called in server environments, detected: "+JSON.stringify(he));if(!t)throw new Error("`setServerClient` can only be called when `ssr: true`");l.instance=n=ge(e),l.canPreviewDrafts=!!n.config().token,a.set(i())},unstable__cache:o,unstable__serverClient:l}},exports.r=he;//# sourceMappingURL=index.cjs.map
